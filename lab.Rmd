---
title: "lab"
output: html_document
date: "2023-09-27"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Todo

+ Add to make-request an error message when token is expired
+ default argument set to JSON for .return
+ Try deleteRecord
+ Transform browser URL into at-uri


## Packages

```{r}
library(tidyverse)
devtools::load_all()
```


## Potential examples

* Make a skeet with text
* Make a skeet with picture

* Get a profile's skeet/following/followers
* Get all members/skeets from one feed
* Get the likes from a post
* Get likes from a profile

## Easy example

```{r}
auth(user = "atpr.bsky.social", 
     password = "cmpd-5mvw-yauz-2lwu")
```

### Get actor preferences

```{r}
app_bsky_actor_get_preferences()
```

### Create a post

```{r}
repo <- "atpr.bsky.social"
collection <- "app.bsky.feed.post"

record <- list(
  "text" = "Testing around",
  "createdAt" = format(as.POSIXct(Sys.time(), tz = "UTC"), "%Y-%m-%dT%H:%M:%OS6Z")
)

resp <- com_atproto_repo_create_record(repo, collection, record)
resp %>% glimpse
```


### Remove post based on at-url

```{r}
#  "at://did:plc:j42kj4qc5vfz344weywpkair/app.bsky.feed.post/3kaz3hsyov22f"
post_info <- parse_at_uri(resp$uri)
resp_delte <- com_atproto_repo_delete_record(repo = post_info$repo, 
                                             collection = post_info$collection, 
                                             rkey = post_info$rkey)
```

### Remove post based on http-url

```{r}
http_url <- "https://bsky.app/profile/atpr.bsky.social/post/3kaz3famddr23"

post_info <- parse_http_url(http_url)
resp_deleted <- com_atproto_repo_delete_record(repo = post_info$repo, 
                                               collection = post_info$collection, 
                                               rkey = post_info$rkey)
```


### Follow a user

```{r}
repo <- "atpr.bsky.social"
collection <- "app.bsky.graph.follow"
handle <- "benguinaudeau.bsky.social"

prof <- app_bsky_actor_get_profile(actor = handle)

record <- list(
  "subject" = prof$did, 
  "createdAt" = format(as.POSIXct(Sys.time(), tz = "UTC"), "%Y-%m-%dT%H:%M:%OS6Z")
)

resp <- com_atproto_repo_create_record(repo, collection, record)
resp
```

### Pagination

```{r}
repo <- "benguinaudeau.bsky.social"
collection <- "app.bsky.graph.follow"

limit <- 1000
out <- c()
last_cursor <- NULL
while(length(out) < limit){
  resp <- com_atproto_repo_list_records(repo, 
                                        collection, 
                                        limit = 100, 
                                        cursor = last_cursor)
  if(is.null(resp$cursor)) break
  last_cursor <- resp$cursor
  out <- c(out, resp[["records"]]) 
  print(length(out))
}
```


### Unfollow a user

```{r}
repo <- "atpr.bsky.social"
handle_to_unfollow <- "benguinaudeau.bsky.social"
collection <- "app.bsky.graph.follow"


resp <- com_atproto_repo_list_records(repo, 
                                      collection, 
                                      limit = 100)

prof <- app_bsky_actor_get_profile(actor = handle_to_unfollow)

record <- resp$records |>
  keep(~.x$value$subject == prof$did)

follow_info <- parse_at_uri(record[[1]]$uri)

follow_deleted <- com_atproto_repo_delete_record(
  repo = follow_info$repo, 
  collection = follow_info$collection, 
  rkey = follow_info$rkey
)

follow_deleted
```



## Authentification

```{r}
auth(user = "atpr.bsky.social", 
     password = "cmpd-5mvw-yauz-2lwu")
```

## Test value used in the unit tests

```{r}
tv <- list(
  handle1 = "aurman21.bsky.social",
  handle2 = "profmusgrave.bsky.social",
  ownhandle = "benguinaudeau.bsky.social",
  
  list1 = "at://did:plc:kyttpb6um57f4c2wep25lqhq/app.bsky.graph.list/3k4diugcw3k2p",
  
  feed_gen1 = 'at://did:plc:kyttpb6um57f4c2wep25lqhq/app.bsky.feed.generator/aaaevewijfbqy', # Polisky
  feed_gen2 = 'at://did:plc:kyttpb6um57f4c2wep25lqhq/app.bsky.feed.generator/aaalfodybabzy', # Skynet
  post_uri = 'at://did:plc:kyttpb6um57f4c2wep25lqhq/app.bsky.feed.post/3k7vuxaw6ew2n',
  post_uri = "https://bsky.app/profile/aoc.bsky.social/post/3jzszuihulm2m",
  feed_gens = c(feed_gen1, feed_gen2),
  aoc_post_1 = "at://did:plc:p7gxyfr5vii5ntpwo7f6dhe2/app.bsky.feed.post/3k26nvf2xdz2m",
  aoc_post_2 = "at://did:plc:p7gxyfr5vii5ntpwo7f6dhe2/app.bsky.feed.post/3k24roywgx726",
  aoc_posts = c(aoc_post_1, aoc_post_2),
  
  feed1 = "at://did:plc:kyttpb6um57f4c2wep25lqhq/app.bsky.feed.generator/aaalfodybabzy",
  feed = "at://did:plc:kyttpb6um57f4c2wep25lqhq/app.bsky.feed.generator/aaaevewijfbqy"
)
usethis::use_data(tv)
```

## Get all lexicons

### Update lexicons

```{r}
# list_lexicons <- github_ls(repo = "https://api.github.com/repos/bluesky-social/atproto/contents", 
#                            folder = "lexicons") |>
#   str_remove("lexicons") |>
#   set_names(
#     fs::path_file(.) |>
#       str_remove(".json")
#   ) |>
#   as.list()
# usethis::use_data(list_lexicons)
```

### Read all lexicons

```{r}
all <- list_lexicons |>
  map_dfr(~{
    tibble::tibble(
      id = .x,
      lexicon = list(read_lexicon(.x))
    ) |>
      mutate(
        type = lexicon[[1]] |>
          purrr::pluck("defs", "main", "type")
      )
  })

all |> glimpse

all |> count(type, sort = T)
all |> filter(is.na(type))
```


### Check lexicons type

```{r}
all |>
  add_count(type) |>
  distinct(type, .keep_all = T) |>
  rename(example = id) |>
  arrange(desc(n))
```

## Generate functions

### Generate the functions

```{r}
# dput(names(list_lexicons[str_detect(names(list_lexicons), "^get")]))

list_lexicons |> #bashR::simule_map(4)
  walk(~{
    glimpse(.x)
    out_file <- paste0("R/auto_", janitor::make_clean_names(fs::path_dir(.x)), ".R")
    build_function(lexicon = .x, out_file = out_file)
  })

```


## Testing function

```{r}
arg_list <-  ls("package:atr") |>
  str_subset("^(app|com)") |>
  map_dfr(~{
    tibble::tibble(
      fun = .x,
      param = formalArgs(get(.x, envir = asNamespace('atr')))
    )
  })

arg_list |>
  filter(!param %in% c("actor", "actors", "limit", "cursor")) |>
  arrange(param) |>
  glimpse
```

## Testing post endpoitn 

### Write post

```{r}
repo <- "benguinaudeau.bsky.social"
collection <- "app.bsky.feed.post"

record <- list(
  "text" = "Testing around",
  "createdAt" = format(as.POSIXct(Sys.time(), tz = "UTC"), "%Y-%m-%dT%H:%M:%OS6Z")
)

resp <- com_atproto_repo_create_record(repo, collection, record, .token = token, .return = "resp")
params
resp

post_skeet <- function(test = ..., picture = NULL){
  
}
```

### Get Likes

```{r}
resp <- app_bsky_feed_get_likes(uri = "at://pwnallthethings.bsky.social/post/3kawf4bv5v62e", .token = .token, .return = "json")


```


### Follow an account

```{r}
repo <- ""
collection <- "app.bsky.graph.follow"
handle <- "benguinaudeau.bsky.social"
prof <- app_bsky_actor_get_profile(actor = handle, .token = .token, .return = "json")
prof

record <- list(
  "subject" = prof$did
  # "createdAt" = format(as.POSIXct(Sys.time(), tz = "UTC"), "%Y-%m-%dT%H:%M:%OS6Z")
)

## Delete

follows <- app_bsky_graph_get_follows(actor = "benguinaudeau.bsky.social", 
                                      .token = .token, 
                                      limit = 100,
                                      .return = "json")

follows$follows |>
  keep(~.x$did == handle)

resp <- com_atproto_repo_delete_record(repo, collection, record, 
                                       .token = .token, .return = "json")

resp <- com_atproto_repo_create_record(repo, collection, record, .token = .token, .return = "resp")

httr2::last_response() |>
  httr2::resp_body_json()




```




## Automatize Testing

```{r}
# app_bsky_actor_get_profile <- function(actor){
#   
#   get_params <- match.call(expand.dots = FALSE) |>
#     flatten_query_params()
#   
#   list(
#     scheme = 'https', 
#     hostname = glue::glue('bsky.social/xrpc/app.bsky.actor.getProfile'),
#     query = as.list(get_params)
#   ) |>
#     app_bsky_actor_get_profile_int() |> 
#     httr2::resp_body_json()
# }

# app_bsky_actor_get_profile_int <- function(all_params){
#   all_params |>
#     httr2::url_build() |>
#     httr2::request() |> 
#     httr2::req_method('GET') |>
#     httr2::req_headers(
#       Authorization = paste0('Bearer ', token$accessJwt)
#     ) |> 
#     httr2::req_perform()
# }

req <- list(
  scheme = 'https', 
  hostname = glue::glue('bsky.social/xrpc/app.bsky.actor.getProfile'),
  query = list(actor = "benguinaudeau.bsky.social")
) |>
  app_bsky_actor_get_profile_int

# <httr2_response>
# GET https://bsky.social/xrpc/app.bsky.actor.getProfile?actor=benguinaudeau.bsky.social
# Status: 200 OK
# Content-Type: application/json
# Body: In memory (785 bytes)

httr2::resp_body_string(req)

# "{\"did\":\"did:plc:vuvsifrusnjsys7mhkpk662u\",\"handle\":\"benguinaudeau.bsky.social\",\"displayName\":\"Benjamin Guinaudeau\",\"description\":\"Postdoc @CSMaP_NYU. \\n\\nPolitics, data science, and hacking stuff in #rstats. \\n\\nðŸ‡«ðŸ‡· in ðŸ‡©ðŸ‡ª/ðŸ‡¨ðŸ‡¦ he/him\\n\\nPrev: PoliSci PhD @UniKonstanz and @Meta CDS\\n\\nWebsite: http://benguinaudeau.com\",\"avatar\":\"https://av-cdn.bsky.app/img/avatar/plain/did:plc:vuvsifrusnjsys7mhkpk662u/bafkreieahfe2ttg5dfk7btivcpr2onoztgzdjh4valkxqpji42qpkmwacq@jpeg\",\"banner\":\"https://av-cdn.bsky.app/img/banner/plain/did:plc:vuvsifrusnjsys7mhkpk662u/bafkreigv4ycltavnhofcjgkrzhxuoaa6eotimeocfdqmirc2dxfrvfbsuu@jpeg\",\"followsCount\":129,\"followersCount\":223,\"postsCount\":15,\"indexedAt\":\"2023-09-19T00:08:33.661Z\",\"viewer\":{\"muted\":false,\"blockedBy\":false},\"labels\":[]}"

app_bsky_actor_get_profile(actor = "benguinaudeau.bsky.social") |>
  jsonlite::toJSON()

{"did":["did:plc:vuvsifrusnjsys7mhkpk662u"],"handle":["benguinaudeau.bsky.social"],"displayName":["Benjamin Guinaudeau"],"description":["Postdoc @CSMaP_NYU. \n\nPolitics, data science, and hacking stuff in #rstats. \n\nðŸ‡«ðŸ‡· in ðŸ‡©ðŸ‡ª/ðŸ‡¨ðŸ‡¦ he/him\n\nPrev: PoliSci PhD @UniKonstanz and @Meta CDS\n\nWebsite: http://benguinaudeau.com"],"avatar":["https://av-cdn.bsky.app/img/avatar/plain/did:plc:vuvsifrusnjsys7mhkpk662u/bafkreieahfe2ttg5dfk7btivcpr2onoztgzdjh4valkxqpji42qpkmwacq@jpeg"],"banner":["https://av-cdn.bsky.app/img/banner/plain/did:plc:vuvsifrusnjsys7mhkpk662u/bafkreigv4ycltavnhofcjgkrzhxuoaa6eotimeocfdqmirc2dxfrvfbsuu@jpeg"],"followsCount":[129],"followersCount":[223],"postsCount":[15],"indexedAt":["2023-09-19T00:08:33.661Z"],"viewer":{"muted":[false],"blockedBy":[false]},"labels":[]} 

```

0. Intro
1. Function code
2. Row response
3. Parsed response


```{r}
all_funs <- unique(arg_list$fun) |>
  str_subset("^(app|com)") |>
  str_subset("get")

fun_name <- sample(all_funs, 1)
```

```{r}
fun_code <- paste0(fun_name, "< - ", paste(deparse(get(fun_name)), collapse = "\n"))

all_test <- get_params(fun_name)

test <- all_test |> 
  sample(ceiling(.2 * length(.))) |>
  map_dfr(~{
    resp <- eval(parse(text = one_test))
    json <- resp |>
      httr2::resp_body_json() |>
      jsonlite::toJSON()
    
    tibble::tibble(
      code = .x, 
      resp = list(resp), 
      json = list(json)
    )
    
  })

test_for_prompt <- test |>
  split(1:nrow(.)) |> #bashR::simule_map(1)
  map_chr(~{
    
    out <- list()
    out[[1]] <- paste(.x$code, "|> glimpse")
    out[[2]] <- capture.output(.x$resp[[1]] |> glimpse)
    out[[3]] <- "\n\nJSON content: "
    out[[4]] <- .x$json[[1]]
    
    paste(out, collapse = "\n")
    
  })

final_prompt <- c(
  "I am writting an R package to query data stored and transfered using the AT protocol described on this webpage: https://atproto.com/guides/overview. 

This is many ways similar to the python library atproto: https://github.com/MarshalX/atproto

I have generated the function querying the API and need your help to write unit testing of the functions.
Write unit test in the style of testthat, only include code that can write into an Rscript file and run devtools::test(). Include as many test as possible", 
"Function code: ", fun_code, 
"Output examples:", paste(test_for_prompt[1], collapse = "\n")
) |>
  paste(collapse = "\n")

# str_length(final_prompt)
# writeLines(final_prompt, "test_prompt.txt")

new_fun <- askgpt::chat_api(prompt = final_prompt,
                            model = "gpt-3.5-turbo-16k") |>
  askgpt::parse_response()


cat(new_fun )
```











## Manual testing


```{r}
app_bsky_actor_get_preferences(.token = token, .return =  "resp")
app_bsky_actor_get_preferences(.token = token, .return =  "json")

app_bsky_actor_get_profile(actor = handle1, .token = token)
app_bsky_actor_get_profiles(actors = c(handle1, handle2), .token = token)

app_bsky_actor_get_suggestions(.token = token)

app_bsky_notification_get_unread_count(.token = token)
app_bsky_notification_list_notifications(.token = token)
res1 <-app_bsky_notification_list_notifications(limit = 5, .token = token)
res2 <-app_bsky_notification_list_notifications(limit = 5, cursor = res1$cursor, .token = token)

app_bsky_graph_get_followers(actor = handle1, .token = token)
res1 <- app_bsky_graph_get_followers(actor = handle1, limit = 5, .token = token)
res2 <- app_bsky_graph_get_followers(actor = handle1, limit = 5, cursor = res2$cursor, .token = token)

app_bsky_graph_get_follows(actor = handle1, .token = token)
res1 <- app_bsky_graph_get_follows(actor = handle1, limit = 5, .token = token)
res2 <- app_bsky_graph_get_follows(actor = handle1, limit = 5, cursor = res2$cursor, .token = token)


posts <- app_bsky_feed_get_actor_feeds("profmusgrave.bsky.social", .token = token)
posts$feeds |>
  map_chr(~.x$uri)


app_bsky_graph_get_list(list = list1, .token = token)
app_bsky_feed_get_list_feed(list = list1, .token = token)
app_bsky_graph_get_lists(actor = handle2, .token = token)
app_bsky_graph_get_list_blocks(.token = token)
app_bsky_graph_get_list_mutes(.token = token)

# app_bsky_feed_get_actor_feeds(actor = )
app_bsky_feed_get_author_feed(actor = handle2, .token = token)
app_bsky_feed_get_author_feed(actor = handle2, filter = "posts_with_media", .token = token)

# Only for own account
app_bsky_feed_get_actor_likes(actor = handle3, .token = token)

# Generator


app_bsky_feed_get_feed(feed = feed_gen1, .token = token)
app_bsky_feed_get_feed_generator(feed = feed_gen1, .token = token)
app_bsky_feed_get_feed_generators(feed = feed_gens, .token = token)

app_bsky_feed_get_likes(uri = feed_gen1, .token = token)
app_bsky_feed_get_likes(uri = post_uri, .token = token)
app_bsky_feed_get_reposted_by(uri = post_uri, .token = token)

app_bsky_feed_get_suggested_feeds(.token = token)

app_bsky_feed_get_posts(uris = c(post_uri), .token = token)


# Unclear
# app_bsky_feed_get_feed_skeleton(feed = feed_gen1)

```
